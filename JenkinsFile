#!/usr/bin/env groovy

env.terraform_version = "0.12.31"
def label = "jenkins-vg-agent"
def notify_channel = '#jenkins-notify'

podTemplate(label: label, containers: [
        containerTemplate(name: 'jenkins-agent',
                image: "hashicorp/terraform:${env.terraform_version}",
                ttyEnabled: true,
                command: 'cat')
]) {
  node(label) {
    stage('Notify') {
                slackSend channel: "${notify_channel}", color: "warning", message: "ritz-EKS cluster updating. (<$BUILD_URL|see details>)"
            }

    withAWS(credentials: 'ritz-aws-credentials', region: 'ap-southeast-1') {
        container('jenkins-agent') {
            stage('Checkout') {
                checkout scm
                }
            stage('terraform init') {
                sh 'terraform init -input=false'
            }
            stage('terraform validate') {
                sh 'terraform validate'
            }
            stage('terraform fmt') {
                sh 'terraform fmt'
            }
            stage('terraform plan') {
                sh 'terraform plan -out=tfplan -input=false'
            }
            stage('terraform apply') {
                sh 'terraform apply -input=false tfplan'
            }
            stage('Notify') {
                slackSend channel: "${notify_channel}", color: "warning", message: "ritz-EKS cluster is ready. (<$BUILD_URL|see details>)"
            }
      }
    }

  }
}
